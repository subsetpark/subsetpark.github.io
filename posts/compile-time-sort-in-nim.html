<!DOCTYPE html><html lang=en> <head><meta charset=utf-8><title>Subset Park: Compile-Time Sort in Nim</title><meta name=viewport content="width=device-width, initial-scale=1.0"><meta name=description content="{loglevel, debug}"><meta name=author content="Z. D. Smith"><link href="https://fonts.googleapis.com/css2?family=Old+Standard+TT:ital,wght@0,400;0,700;1,400&display=swap" rel=stylesheet><link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Serif:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel=stylesheet><link href=../assets/bootstrap.min.css rel=stylesheet><link href=../assets/bootstrap-responsive.min.css rel=stylesheet><link href=../assets/styles.css rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.9/styles/ascetic.min.css><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.9/highlight.min.js></script><script>hljs.initHighlightingOnLoad();</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link rel=alternate type=application/rss+xml title=RSS href=../feed.xml></head> <body> <div class=container> <div class=row> <div class=col-md-1></div> <div class=col-md-10> <div class=masthead> <div class=navbar> <div class=navbar-inner> <div class=container> <ul class=nav> <li class=active><a href=../index.html>Home</a></li> <li><a href=../posts/index.html>Posts</a></li> <li><a href=../notes/index.html>Notes</a></li> <li><a href=../pages/about.html>About</a></li> <li><a href=../pages/illustrated-whist.html>Illustrated Whist</a></li> </ul> </div> </div> </div><!-- /.navbar --> </div> <div class=body> <div class=container> <div class=row> <div class=col-md-7> <h1>Compile-Time Sort in Nim</h1> <p class=post-info> 2017-06-06 </p> <h2>Compile-Time Sort in D</h2> <p>Michael Parker recently wrote a blog post showing how to implement a <a href=https://dlang.org/blog/2017/06/05/compile-time-sort-in-d/ >compile-time quicksort in D</a> after Bj√∂rn Fahller recently wrote a blog post showing how to implement a <a href=http://playfulprogramming.blogspot.kr/2017/06/constexpr-quicksort-in-c17.html>compile-time quicksort in C++17</a>. It's a skillful demonstration that employs D's powerful compile-time programming capabilities to write code that, while not always useful, is quite concise.</p> <p>Reading it, of course, the thought that came to my mind was &quot;Surely Nim can do better.&quot;[^1]</p> <p>First let's take a quick look at Michael's D code:</p> <pre><code class=language-D>void main() {
    import std.algorithm, std.stdio;
    enum a = [ 3, 1, 2, 4, 0 ];
    static b = sort(a);
    writeln(b); // [0, 1, 2, 3, 4]
}
</code></pre> <p>I won't rehash his whole post, which is lucid and pleasurable to read, but here's the basic gist: we declare an <em>enum</em>, which is a special kind of constant[^2] only available at compile time. The call to <code>sort</code> is prepended by the <code>static</code> keyword, which binds the result of a compile-time evaluation to a static variable available at runtime. The call to <code>writeln</code> is runtime-only, and thus happens whenever <code>main()</code> is called.</p> <p>[^1]: Not really. It was more like, <em>that's super cool! Can Nim do that?</em></p> <p>[^2]: It turns out that in D, if you declare an enum with only one value (in this case a list), it is declared to be a <em>manifest constant</em>. That seems to me like a slightly strange way of getting a compile-time-only value, but I'm not a D programmer.</p> <p>This is a nicely modern approach, bereft of boilerplate, fairly easy to understand, and allows the programmer to execute arbitrary code at compile-time. Michael gives a nice example of some complicated mathy code that is used to validate numeric parameters both at runtime and compile time. It does have a few constraints, though:</p> <blockquote> <p>The fundamental requirements for CTFE eligibility are that a function must be portable, free of side effects, contain no inline assembly, and the source code must be available.</p> </blockquote> <h2>Compile-Time Sort in Nim</h2> <p>Now let's look at an equivalent program written in Nim:</p> <pre><code class=language-nimrod>import algorithm

static:
  var a = @[3, 1, 2, 4, 0]
  sort(a, system.cmp)

const b = a
echo b
</code></pre> <p>You can probably see that the structure is very similar. There are a couple subtle differences, so we'll go through it. The first difference is that the first two statements, equivalent to the first two statements in the D code are evaluated in a <code>static</code> block. There's nothing about the statements themselves specific to compile-time execution; rather it's the context provided by their scope that indicates it's happening at compile time. Now that we're outside the <code>static</code> block, we're back in the runtime; we bind <code>b</code> outside of the static context with a <code>const</code>[^3], and echo during execution of the program itself.</p> <p>[^3]: The <code>const</code> keyword behaves very similarly to D's <code>static</code>.</p> <p>Really, the only differences here are syntactic; I prefer Nim's designation of execution context with blocks rather than the somewhat more occult special-casing of single-value <code>enum</code>s, but they have equal expressive power. But let's look at what the Nim docs say about <code>static</code>:</p> <blockquote> <p>A static statement/expression can be used to enforce compile time evaluation explicitly. Enforced compile time evaluation can even evaluate code that has side effects[.]</p> </blockquote> <p>Whoa! That's a difference. Unlike in the D example, Nim static statements <em>can</em> perform IO. So that means we could write:</p> <pre><code class=language-nimrod>import algorithm

static:
  var a = @[3, 1, 2, 4, 0]
  sort(a, system.cmp)
  echo a

const b = a
echo b
</code></pre> <p>And the constant is echoed once during compilation, then again whenever you run the application.</p> <h2>Compile-Time Side Effects</h2> <p>What this means is that in addition to computationally intensive code, we can perform other useful operations at compile time. Here's a reformatted <a href=https://forum.nim-lang.org/t/2708>example from the Nim forums</a> that demonstrates effectful code during compilation:</p> <pre><code class=language-nimrod>import strutils, tables

static:
  let configLines = &quot;configfile.ini&quot;.slurp().splitLines()

  var keyValues = newSeq[(string, string)]()

  for line in configLines:
    if line.len &gt; 0 and line[0] != ';':
      let splitLine = line.split('=')
      keyValues.add((splitLine[0].strip().toLowerAscii(), splitLine[1].strip()))

const config = keyValues.toTable()
</code></pre> <p>Here, we statically read a config file during compilation and build a table out of it, which we can then bind into the runtime scope as a constant available at runtime. This is a neat trick, allowing us to easily parameterize builds (for instance).</p> </div> <div class=col-md-3> <h3>Recent Posts</h3> <table class=recent-posts> <tr> <td style=white-space:nowrap>2022-02-19</td> <td><a href=../posts/a-specification-of-a-note-taking-program.html>A Specification of a Note-Taking Program</a></td> </tr> <tr> <td style=white-space:nowrap>2021-03-20</td> <td><a href=../posts/algorithms-im-proud-of-fill.html>Algorithms I'm Proud Of: Fill</a></td> </tr> <tr> <td style=white-space:nowrap>2020-12-10</td> <td><a href=../posts/bagatto-a-new-static-site-generator.html>Bagatto, a New Static Site Generator</a></td> </tr> <tr> <td style=white-space:nowrap>2020-11-22</td> <td><a href=../posts/a-regular-simplification-of-offenbacher-schrift.html>A Regular Simplification of Offenbacher Schrift</a></td> </tr> <tr> <td style=white-space:nowrap>2020-08-20</td> <td><a href=../posts/mariglia.html>Mariglia</a></td> </tr> </table> </div> </div> </div> </div> <hr> <div class=footer>Built with <a href=https://bagatto.co>Bagatto.</a></div> </div> </div> </div> </body> </html> 